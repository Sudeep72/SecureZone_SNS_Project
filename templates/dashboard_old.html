<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecureZone - Advanced Network Security System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #f8fafc;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        header {
            background: #1e293b;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            border: 1px solid #334155;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        header h1 {
            color: #60a5fa;
            margin-bottom: 5px;
            font-size: 2.5em;
        }

        header p {
            color: #cbd5e1;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #1e293b;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #334155;
            border-left: 5px solid #60a5fa;
            text-align: center;
            transition: all 0.3s;
        }

        .stat-card:hover {
            border-color: #60a5fa;
            box-shadow: 0 5px 15px rgba(96, 165, 250, 0.1);
        }

        .stat-card h3 {
            color: #60a5fa;
            font-size: 0.8em;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #60a5fa;
        }

        .stat-card.critical {
            border-left-color: #ef4444;
        }

        .stat-card.critical h3 {
            color: #ef4444;
        }

        .stat-card.warning {
            border-left-color: #f59e0b;
        }

        .stat-card.warning h3 {
            color: #f59e0b;
        }

        .stat-card.success {
            border-left-color: #10b981;
        }

        .stat-card.success h3 {
            color: #10b981;
        }

        .controls {
            background: #1e293b;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            border: 1px solid #334155;
            text-align: center;
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .controls h3 {
            width: 100%;
            margin-bottom: 15px;
            color: #f8fafc;
        }

        button {
            background: #60a5fa;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.95em;
            transition: all 0.3s;
            font-weight: bold;
        }

        button:hover {
            background: #3b82f6;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.3);
        }

        button:disabled {
            background: #64748b;
            cursor: not-allowed;
            transform: none;
        }

        button.danger {
            background: #ef4444;
        }

        button.danger:hover {
            background: #dc2626;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #334155;
            padding-bottom: 10px;
        }

        .tab-btn {
            background: #1e293b;
            border: 2px solid #334155;
            border-bottom: none;
            color: #cbd5e1;
            padding: 10px 20px;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab-btn.active {
            background: #60a5fa;
            color: white;
            border-color: #60a5fa;
        }

        .content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .content-grid.full {
            grid-template-columns: 1fr;
        }

        .panel {
            background: #1e293b;
            padding: 25px;
            border-radius: 10px;
            border: 1px solid #334155;
            transition: all 0.3s;
        }

        .panel:hover {
            border-color: #60a5fa;
            box-shadow: 0 5px 15px rgba(96, 165, 250, 0.1);
        }

        .panel h2 {
            color: #60a5fa;
            margin-bottom: 20px;
            font-size: 1.3em;
            border-bottom: 2px solid #334155;
            padding-bottom: 10px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .alert-item {
            background: #0f172a;
            padding: 15px;
            margin-bottom: 12px;
            border-left: 4px solid #ef4444;
            border-radius: 5px;
            transition: all 0.3s;
        }

        .alert-item:hover {
            background: rgba(239, 68, 68, 0.1);
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.2);
        }

        .alert-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-weight: bold;
            flex-wrap: wrap;
        }

        .alert-score {
            padding: 4px 10px;
            border-radius: 3px;
            background: #334155;
            font-size: 0.85em;
            font-weight: bold;
            margin-top: 5px;
        }

        .alert-score.high {
            background: #ef4444;
            color: white;
        }

        .alert-score.medium {
            background: #f59e0b;
            color: white;
        }

        .alert-score.low {
            background: #10b981;
            color: white;
        }

        .alert-details {
            font-size: 0.85em;
            color: #cbd5e1;
            line-height: 1.5;
        }

        .alert-reasons {
            font-size: 0.8em;
            color: #94a3b8;
            margin-top: 8px;
        }

        .device-item {
            background: #0f172a;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 5px;
            border-left: 4px solid #10b981;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .device-item.critical {
            border-left-color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        .device-name {
            font-weight: bold;
            color: #f8fafc;
        }

        .device-status {
            font-size: 0.8em;
            color: #cbd5e1;
        }

        .device-action-badge {
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 0.75em;
            text-transform: uppercase;
        }

        .badge-block {
            background: #ef4444;
            color: white;
        }

        .badge-quarantine {
            background: #f59e0b;
            color: white;
        }

        .badge-restrict {
            background: #8b5cf6;
            color: white;
        }

        .badge-monitor {
            background: #06b6d4;
            color: white;
        }

        .chart-container {
            position: relative;
            height: 300px;
            background: rgba(15, 23, 42, 0.5);
            border-radius: 8px;
            padding: 10px;
        }

        .topology-container {
            height: 500px;
            background: rgba(15, 23, 42, 0.8);
            border-radius: 8px;
            border: 1px solid #334155;
            position: relative;
            overflow: hidden;
        }

        .no-data {
            color: #94a3b8;
            font-style: italic;
            padding: 20px;
            text-align: center;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #334155;
        }

        .metric-row:last-child {
            border-bottom: none;
        }

        .metric-label {
            color: #cbd5e1;
        }

        .metric-value {
            color: #60a5fa;
            font-weight: bold;
        }

        .loader {
            border: 4px solid #334155;
            border-top: 4px solid #60a5fa;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .isolation-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
            margin: 5px 0;
        }

        .isolation-badge.block {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .isolation-badge.quarantine {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }

        .isolation-badge.restrict {
            background: rgba(139, 92, 246, 0.2);
            color: #8b5cf6;
        }

        .isolation-badge.monitor {
            background: rgba(6, 182, 212, 0.2);
            color: #06b6d4;
        }

        .footer {
            text-align: center;
            color: #cbd5e1;
            margin-top: 30px;
            font-size: 0.9em;
        }

        .scroll-container {
            max-height: 500px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .scroll-container::-webkit-scrollbar {
            width: 8px;
        }

        .scroll-container::-webkit-scrollbar-track {
            background: #0f172a;
            border-radius: 10px;
        }

        .scroll-container::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 10px;
        }

        .scroll-container::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }

        .legend {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            padding: 15px 0;
            border-top: 1px solid #334155;
            margin-top: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85em;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>SecureZone - Enterprise Network Security System</h1>
            <p>Research-Grade Intelligent Dynamic Network Segmentation & Threat Isolation</p>
        </header>

        <div class="stats-grid">
            <div class="stat-card critical">
                <h3>Critical</h3>
                <div class="stat-value" id="stat-critical">0</div>
            </div>
            <div class="stat-card warning">
                <h3>Medium Risk</h3>
                <div class="stat-value" id="stat-medium">0</div>
            </div>
            <div class="stat-card success">
                <h3>Low Risk</h3>
                <div class="stat-value" id="stat-low">0</div>
            </div>
            <div class="stat-card">
                <h3>Devices</h3>
                <div class="stat-value" id="stat-devices">0</div>
            </div>
            <div class="stat-card critical">
                <h3>Isolated</h3>
                <div class="stat-value" id="stat-isolated">0</div>
            </div>
            <div class="stat-card">
                <h3>Rules</h3>
                <div class="stat-value" id="stat-rules">0</div>
            </div>
            <div class="stat-card">
                <h3>Avg Risk</h3>
                <div class="stat-value" id="stat-risk">0%</div>
            </div>
        </div>

        <div class="controls">
            <h3>Security Operations</h3>
            <button onclick="runQuickScan()">Quick Scan</button>
            <button onclick="runDeepScan()">Deep Scan</button>
            <button onclick="refreshDashboard()">Refresh</button>
            <button class="danger" onclick="showIsolationHistory()">Isolation History</button>
            <div id="scan-status" style="display: none; width: 100%; text-align: left;">
                <span class="loader"></span>
                <span id="scan-message">Scanning...</span>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('overview')">Overview</button>
            <button class="tab-btn" onclick="switchTab('alerts')">Active Threats</button>
            <button class="tab-btn" onclick="switchTab('isolation')">Isolation Status</button>
            <button class="tab-btn" onclick="switchTab('topology')">Network Topology</button>
            <button class="tab-btn" onclick="switchTab('analytics')">Analytics</button>
        </div>

        <div id="overview" class="section active">
            <div class="content-grid">
                <div class="panel">
                    <h2>Threat Distribution</h2>
                    <div class="chart-container">
                        <canvas id="threatChart"></canvas>
                    </div>
                </div>
                <div class="panel">
                    <h2>System Performance</h2>
                    <div id="performance-metrics">
                        <div class="no-data">No data yet</div>
                    </div>
                </div>
            </div>

            <div class="content-grid full">
                <div class="panel">
                    <h2>System Health</h2>
                    <div id="system-health">
                        <div class="no-data">No data yet</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="alerts" class="section">
            <div class="content-grid full">
                <div class="panel">
                    <h2>Active Security Alerts</h2>
                    <div id="alerts-list" class="scroll-container">
                        <div class="no-data">No threats detected</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="isolation" class="section">
            <div class="content-grid full">
                <div class="panel">
                    <h2>Device Isolation Status</h2>
                    <div id="devices-list" class="scroll-container">
                        <div class="no-data">No devices isolated</div>
                    </div>
                    <div class="legend" id="legend" style="display: none;">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #ef4444;"></div>
                            <span>BLOCK - Complete Isolation</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #f59e0b;"></div>
                            <span>QUARANTINE - Restricted Access</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #8b5cf6;"></div>
                            <span>RESTRICT - Limited Access</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #06b6d4;"></div>
                            <span>MONITOR - Enhanced Monitoring</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="topology" class="section">
            <div class="content-grid full">
                <div class="panel">
                    <h2>Network Topology & Device Status</h2>
                    <div class="topology-container" id="topology-viz">
                        <div class="no-data">Run a scan to load topology</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="analytics" class="section">
            <div class="content-grid">
                <div class="panel">
                    <h2>Detection Latency</h2>
                    <div class="chart-container">
                        <canvas id="latencyChart"></canvas>
                    </div>
                </div>
                <div class="panel">
                    <h2>Isolation Actions</h2>
                    <div id="isolation-history" class="scroll-container">
                        <div class="no-data">No isolation history</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>SecureZone v3.0 - Advanced Enterprise Network Security System</p>
            <p style="margin-top: 10px; color: #64748b; font-size: 0.85em;">Last Updated: <span id="last-update">--:--:--</span></p>
        </div>
    </div>

    <script>
        let threatChart, latencyChart;
        let dashboardData = {};

        document.addEventListener('DOMContentLoaded', () => {
            initCharts();
            refreshDashboard();
            setInterval(refreshDashboard, 5000);
        });

        function switchTab(tab) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            
            document.getElementById(tab).classList.add('active');
            event.target.classList.add('active');

            if (tab === 'topology') {
                setTimeout(() => updateTopology(dashboardData.topology_data || {}), 100);
            }
        }

        function refreshDashboard() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    dashboardData = data;
                    updateStats(data.threat_statistics || {}, data.network_status || {});
                    updateAlerts(data.recent_alerts || []);
                    updateDevices(data.topology_data || {});
                    updatePerformance(data.performance_metrics || {});
                    updateHealth(data.system_health || {});
                    updateThreatChart(data.threat_statistics || {});
                    document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
                })
                .catch(error => console.error('Error:', error));
        }

        function updateStats(stats, network) {
            document.getElementById('stat-critical').textContent = stats.critical || 0;
            document.getElementById('stat-medium').textContent = stats.medium || 0;
            document.getElementById('stat-low').textContent = stats.low || 0;
            document.getElementById('stat-devices').textContent = network.total_devices || 0;
            document.getElementById('stat-isolated').textContent = network.isolated_devices?.length || 0;
            document.getElementById('stat-rules').textContent = network.active_rules || 0;
            document.getElementById('stat-risk').textContent = (network.average_risk || 0).toFixed(1) + '%';
        }

        function updateAlerts(alerts) {
            const container = document.getElementById('alerts-list');
            
            if (!alerts || alerts.length === 0) {
                container.innerHTML = '<div class="no-data">No threats detected</div>';
                return;
            }

            container.innerHTML = alerts.slice(-20).reverse().map(alert => {
                const riskClass = alert.threat_score >= 70 ? 'high' :
                                alert.threat_score >= 35 ? 'medium' : 'low';
                const time = new Date(alert.timestamp).toLocaleTimeString();

                return `
                    <div class="alert-item ${riskClass}">
                        <div class="alert-header">
                            <span><strong>${alert.source_ip}</strong> → ${alert.destination_ip}</span>
                            <span class="alert-score ${riskClass}">${alert.threat_score}%</span>
                        </div>
                        <div class="alert-details">
                            <div><strong>Protocol:</strong> ${alert.protocol || 'Unknown'} | <strong>Port:</strong> ${alert.dst_port || 'N/A'}</div>
                            <div><strong>Flows:</strong> ${alert.flow_count || 1} | <strong>Time:</strong> ${time}</div>
                        </div>
                        <div class="alert-reasons">
                            ${alert.reasons ? alert.reasons.join(' • ') : 'Anomalous traffic'}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateDevices(topology) {
            const container = document.getElementById('devices-list');
            const legendDiv = document.getElementById('legend');
            const nodes = topology.nodes || [];
            const isolatedNodes = nodes.filter(n => n.isolated);

            if (isolatedNodes.length === 0) {
                container.innerHTML = '<div class="no-data">No devices isolated</div>';
                legendDiv.style.display = 'none';
                return;
            }

            legendDiv.style.display = 'grid';
            container.innerHTML = isolatedNodes.map(node => {
                let badgeClass = 'monitor';
                let badgeText = 'MONITOR';
                
                if (node.current_risk >= 90) {
                    badgeClass = 'block';
                    badgeText = 'BLOCK';
                } else if (node.current_risk >= 70) {
                    badgeClass = 'quarantine';
                    badgeText = 'QUARANTINE';
                } else if (node.current_risk >= 40) {
                    badgeClass = 'restrict';
                    badgeText = 'RESTRICT';
                }

                return `
                    <div class="device-item critical">
                        <div>
                            <div class="device-name">${node.id}</div>
                            <div class="device-status">
                                IP: ${node.ip} | Type: ${node.type} | Risk: ${node.current_risk}%
                            </div>
                        </div>
                        <div>
                            <span class="device-action-badge badge-${badgeClass}">${badgeText}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updatePerformance(metrics) {
            const container = document.getElementById('performance-metrics');
            
            if (!metrics || Object.keys(metrics).length === 0) {
                container.innerHTML = '<div class="no-data">No metrics available</div>';
                return;
            }

            container.innerHTML = `
                <div class="metric-row">
                    <span class="metric-label">Avg Detection Latency</span>
                    <span class="metric-value">${(metrics.avg_detection_latency || 0).toFixed(3)}s</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Max Detection Latency</span>
                    <span class="metric-value">${(metrics.max_detection_latency || 0).toFixed(3)}s</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Total Detections</span>
                    <span class="metric-value">${metrics.total_detections || 0}</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Total Isolations</span>
                    <span class="metric-value">${metrics.total_isolations || 0}</span>
                </div>
            `;
        }

        function updateHealth(health) {
            const container = document.getElementById('system-health');
            
            if (!health || Object.keys(health).length === 0) {
                container.innerHTML = '<div class="no-data">No health data available</div>';
                return;
            }

            container.innerHTML = `
                <div class="metric-row">
                    <span class="metric-label">CPU Usage</span>
                    <span class="metric-value">${(health.cpu_usage || 0).toFixed(1)}%</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Memory Usage</span>
                    <span class="metric-value">${(health.memory_usage || 0).toFixed(1)}%</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Network Utilization</span>
                    <span class="metric-value">${(health.network_utilization || 0).toFixed(1)}%</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Detection Accuracy</span>
                    <span class="metric-value">${(health.threat_detection_accuracy || 0).toFixed(1)}%</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Ensemble Performance</span>
                    <span class="metric-value">${(health.ensemble_model_performance || 0).toFixed(1)}%</span>
                </div>
            `;
        }

        function updateThreatChart(stats) {
            if (!threatChart) return;
            threatChart.data.datasets[0].data = [
                stats.critical || 0,
                stats.medium || 0,
                stats.low || 0
            ];
            threatChart.update('none');
        }

        function initCharts() {
            const threatCtx = document.getElementById('threatChart').getContext('2d');
            threatChart = new Chart(threatCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Critical', 'Medium Risk', 'Low Risk'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: ['#ef4444', '#3b82f6', '#10b981'],
                        borderColor: '#1e293b',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#f8fafc', font: { size: 11 }, padding: 15 }
                        }
                    }
                }
            });

            const latencyCtx = document.getElementById('latencyChart').getContext('2d');
            latencyChart = new Chart(latencyCtx, {
                type: 'line',
                data: {
                    labels: ['0s', '10s', '20s', '30s', '40s', '50s'],
                    datasets: [{
                        label: 'Detection Latency (ms)',
                        data: [0, 0, 0, 0, 0, 0],
                        borderColor: '#60a5fa',
                        backgroundColor: 'rgba(96, 165, 250, 0.1)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#f8fafc' } }
                    },
                    scales: {
                        y: { ticks: { color: '#f8fafc' }, grid: { color: '#334155' } },
                        x: { ticks: { color: '#f8fafc' }, grid: { color: '#334155' } }
                    }
                }
            });
        }

        function updateTopology(topology) {
            const container = document.getElementById('topology-viz');
            const nodes = topology.nodes || [];
            const edges = topology.edges || [];

            if (nodes.length === 0) {
                container.innerHTML = '<div class="no-data">No topology data available</div>';
                return;
            }

            container.innerHTML = '';
            const width = container.clientWidth;
            const height = container.clientHeight;

            const svg = d3.select('#topology-viz')
                .append('svg')
                .attr('width', width)
                .attr('height', height);

            const simulation = d3.forceSimulation(nodes)
                .force('link', d3.forceLink(edges).id(d => d.id).distance(120))
                .force('charge', d3.forceManyBody().strength(-400))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(25));

            const links = svg.selectAll('line')
                .data(edges)
                .enter().append('line')
                .style('stroke', '#64748b')
                .style('stroke-width', 2)
                .style('opacity', 0.6);

            const nodeGroups = svg.selectAll('g.node')
                .data(nodes)
                .enter().append('g')
                .attr('class', 'node')
                .call(d3.drag()
                    .on('start', dragStart)
                    .on('drag', dragged)
                    .on('end', dragEnd));

            nodeGroups.append('circle')
                .attr('r', 18)
                .style('fill', d => {
                    if (d.isolated) return '#ef4444';
                    if (d.risk_level === 'critical') return '#ef4444';
                    if (d.risk_level === 'high') return '#f59e0b';
                    if (d.risk_level === 'medium') return '#3b82f6';
                    return '#10b981';
                })
                .style('stroke', '#f8fafc')
                .style('stroke-width', 3)
                .style('filter', 'drop-shadow(2px 2px 4px rgba(0,0,0,0.3))');

            nodeGroups.append('text')
                .attr('text-anchor', 'middle')
                .attr('dy', 40)
                .style('fill', '#f8fafc')
                .style('font-size', '11px')
                .style('font-weight', '600')
                .text(d => d.id.replace('_', ' '));

            nodeGroups.append('text')
                .attr('text-anchor', 'middle')
                .attr('dy', 55)
                .style('fill', '#cbd5e1')
                .style('font-size', '9px')
                .text(d => d.ip);

            simulation.on('tick', () => {
                links
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);

                nodeGroups.attr('transform', d => `translate(${d.x},${d.y})`);
            });

            function dragStart(event, d) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }

            function dragged(event, d) {
                d.fx = event.x;
                d.fy = event.y;
            }

            function dragEnd(event, d) {
                if (!event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }
        }

        function showIsolationHistory() {
            fetch('/api/isolation_history')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('isolation-history');
                    const history = data.history || [];

                    if (history.length === 0) {
                        container.innerHTML = '<div class="no-data">No isolation history</div>';
                        return;
                    }

                    container.innerHTML = history.slice(-20).reverse().map(item => {
                        let badgeClass = 'monitor';
                        let badgeText = 'MONITOR';
                        
                        if (item.isolation_level === 'maximum') {
                            badgeClass = 'block';
                            badgeText = 'BLOCK';
                        } else if (item.isolation_level === 'high') {
                            badgeClass = 'quarantine';
                            badgeText = 'QUARANTINE';
                        } else if (item.isolation_level === 'medium') {
                            badgeClass = 'restrict';
                            badgeText = 'RESTRICT';
                        }

                        return `
                            <div class="alert-item">
                                <div class="alert-header">
                                    <strong>${item.device_id}</strong>
                                    <span class="isolation-badge ${badgeClass}">
                                        ${badgeText}
                                    </span>
                                </div>
                                <div class="alert-details">
                                    <div>Level: <strong>${item.isolation_level}</strong> | Threat: <strong>${item.threat_score}</strong></div>
                                    <div>Time: ${new Date(item.timestamp).toLocaleString()}</div>
                                </div>
                            </div>
                        `;
                    }).join('');

                    switchTab('analytics');
                });
        }

        function runQuickScan() {
            runScan('quick');
        }

        function runDeepScan() {
            runScan('deep');
        }

        function runScan(scanType) {
            const statusDiv = document.getElementById('scan-status');
            const messageSpan = document.getElementById('scan-message');
            statusDiv.style.display = 'block';
            messageSpan.textContent = `Running ${scanType} scan...`;
            messageSpan.style.color = '#f8fafc';

            fetch('/api/run_scan', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ scan_type: scanType })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    messageSpan.textContent = `${scanType.toUpperCase()} scan complete - ${data.traffic_analyzed} flows analyzed, ${data.anomalies_detected} anomalies detected, ${data.threats_detected} threats isolated`;
                    messageSpan.style.color = '#10b981';
                    
                    setTimeout(() => {
                        refreshDashboard();
                        statusDiv.style.display = 'none';
                    }, 1500);
                } else {
                    messageSpan.textContent = `Scan failed: ${data.error || 'Unknown error'}`;
                    messageSpan.style.color = '#ef4444';
                    statusDiv.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Scan error:', error);
                messageSpan.textContent = `Error: ${error.message}`;
                messageSpan.style.color = '#ef4444';
                statusDiv.style.display = 'none';
            });
        }
    </script>
</body>
</html>